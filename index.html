<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SURVEYio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Core Styles & Variables --- */
        :root {
            --primary-color: #ff4500;
            --dark-blue: #1a237e;
            --light-gray: #f5f7fa;
            --border-color: #e0e4e8;
            --dark-blue-gray: #455a64;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --card-padding: 1.25rem;
            --card-radius: 12px;
            --button-radius: 8px;
            --background-color: #FFFFFF;
        }

        /* --- Universal Styles --- */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; min-height: 100vh; font-family: 'Poppins', sans-serif; background-color: var(--light-gray); color: var(--text-primary); }
        body { display: flex; justify-content: center; align-items: center; padding: 1rem; }
        @media (max-width: 480px) { body { padding: 0; } }

        /* --- App Container --- */
        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--background-color);
            position: relative;
            overflow: hidden;
        }
        @media (min-width: 481px) { .app-container { max-height: 98vh; border-radius: 40px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); } }

        /* --- Section Management --- */
        .section {
            width: 100%;
            height: 100%;
            display: none; /* All sections are hidden by default */
            flex-direction: column;
            flex-grow: 1;
        }
        .section.active {
            display: flex; /* Only the active section is shown */
        }
        
        /* --- AUTH SECTION STYLES --- */
        .auth-section-inner { padding: 2.5rem 1.5rem; text-align: center; display: none; flex-direction: column; justify-content: space-between; flex-grow: 1; overflow-y: auto; }
        .auth-section-inner.active { display: flex; }
        #landing-page h1 { font-size: clamp(1.8rem, 8vw, 2.5rem); font-weight: 700; line-height: 1.2; margin: 0 0 2rem 0; }
        .main-button, .secondary-button { width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 50px; cursor: pointer; transition: background-color 0.3s; }
        .main-button { color: white; background-color: var(--dark-blue-gray); border: none; margin-bottom: 1rem; }
        .secondary-button { color: var(--text-primary); background-color: transparent; border: 1px solid var(--border-color); }
        .form-header h1 { font-size: 2.2rem; }
        .input-group { margin-bottom: 1.2rem; text-align: left; }
        input[type="email"], input[type="password"], input[type="text"], input[type="date"] { width: 100%; padding: 0.9rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .btn { width: 100%; padding: 0.95rem; border: none; border-radius: 8px; background-color: var(--dark-blue-gray); color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .switch-form a { color: #007bff; font-weight: 600; cursor: pointer; }
        .error-message { color: #dc3545; font-size: 0.85rem; margin-top: 0.5rem; text-align: center; display: none; }

        /* --- MAIN APP SECTION STYLES --- */
        .page { display: none; padding: 1rem; flex-direction: column; flex-grow: 1; }
        .page.active { display: flex; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #fff; border-bottom: 1px solid var(--border-color); gap: 1rem; }
        .app-title-animated { font-size: 1.6rem; font-weight: 700; background: linear-gradient(to right, var(--primary-color) 20%, var(--text-primary) 40%, var(--text-primary) 60%, var(--primary-color) 80%); background-size: 200% auto; color: transparent; background-clip: text; -webkit-background-clip: text; animation: shimmer-effect 4s linear infinite; }
        @keyframes shimmer-effect { to { background-position: -200% center; } }
        .search-container { flex-grow: 1; position: relative; }
        #task-search-input { width: 100%; box-sizing: border-box; padding: 0.6rem 1rem 0.6rem 2.5rem; border: 1px solid var(--border-color); border-radius: 20px; font-size: 1rem; background-color: var(--light-gray); }
        .search-icon { position: absolute; top: 50%; left: 0.8rem; transform: translateY(-50%); width: 20px; height: 20px; color: var(--text-secondary); }
        .balance-display { background-color: #000; color: #fff; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; flex-shrink: 0; }
        .task-list, #activities-list, .account-page-content { flex-grow: 1; overflow-y: auto; padding-bottom: 1rem; }
        .task-card { background-color: #fff; border: 1px solid var(--border-color); border-radius: var(--card-radius); padding: var(--card-padding); margin-bottom: 1.25rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; }
        .wallet-card { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 1.5rem; border-radius: 16px; }
        .accordion-card { background: white; border: 1px solid var(--border-color); border-radius: var(--card-radius); margin-bottom: 1rem; overflow: hidden; }
        .accordion-header { display: flex; justify-content: space-between; align-items: center; padding: var(--card-padding); cursor: pointer; }
        .arrow-icon { transform: rotate(0deg); transition: transform 0.3s ease; }
        .accordion-header.active .arrow-icon { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; padding: 0 var(--card-padding); }
        .accordion-content p { margin: 0 0 1rem 0; line-height: 1.6; color: var(--text-secondary); }
        .accordion-content a { color: var(--text-primary); text-decoration: none; font-weight: 500;}
        .accordion-content.show { max-height: 600px; padding-bottom: var(--card-padding); }
        .profile-display { text-align: center; padding-bottom: 1rem; }
        .profile-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin: 0 auto 1rem; border: 3px solid var(--border-color); background-color: #f0f0f0; }
        .avatar-selection { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .avatar-option { width: 100%; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #f0f0f0; padding: 5px; }
        .avatar-option.selected { border-color: var(--primary-color); }
        .save-btn { width: 100%; padding: 0.9rem; border-radius: var(--button-radius); font-size: 1rem; cursor: pointer; border: none; font-weight: 500; background-color: var(--dark-blue); color: white; }
        .save-btn.saved { background-color: #4caf50; }
        .action-button, .social-button { width: 100%; padding: 0.9rem; border-radius: var(--button-radius); font-size: 1rem; cursor: pointer; border: none; font-weight: 500; text-decoration: none; display: block; text-align: center; }
        .logout-btn { background-color: var(--dark-blue-gray); color: white; }
        .social-button { margin-bottom: 0.5rem; color: white; }
        .social-button.telegram { background-color: #0088cc; }
        .social-button.whatsapp { background-color: #25d366; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .bottom-nav { display: flex; justify-content: space-around; background-color: #fff; border-top: 1px solid #eee; padding: 0.5rem 0; flex-shrink: 0; }
        .nav-item { text-align: center; color: #999; text-decoration: none; font-size: 0.75rem; }
        .nav-item.active { color: var(--primary-color); }
        .nav-icon svg { width: 28px; height: 28px; fill: currentColor; }
    </style>
</head>
<body>

    <div class="app-container">

        <!-- AUTHENTICATION SECTION -->
        <div class="section" id="auth-section">
            <div class="auth-section-inner active" id="landing-page">
                 <div class="art-design-container"><svg class="art-design-svg" viewBox="0 0 300 200"><path d="M50,50 C100,0 200,150 250,100" stroke="black" stroke-width="4" fill="none" /><path d="M40,42 C70,12 110,12 140,42" stroke="#FF6347" stroke-width="6" fill="none" stroke-linecap="round" /><path d="M110,19 C140,-1 180,-1 200,19" stroke="#8A2BE2" stroke-width="6" fill="none" stroke-linecap="round" transform="rotate(20, 150, 50)" /><g transform="translate(40, 90)"><rect x="0" y="0" width="60" height="40" rx="8" fill="#FFC107" /><circle cx="30" cy="20" r="10" fill="white" /><circle cx="10" cy="10" r="3" fill="white" /></g><g transform="translate(180, 20)"><path d="M0,0 H60 V40 H20 L10,50 L10,40 H0 Z" fill="#2E8B57" rx="8" /></g><g transform="translate(150, 130)"><path d="M0 15 L30 0 L80 0 L50 15 Z" fill="#1E90FF"/><path d="M0 15 L0 30 L50 30 L50 15 Z" fill="#1E90FF"/><path d="M50 15 L50 30 L80 15 L80 0 Z" fill="#4169E1"/><rect x="35" y="3" width="10" height="8" fill="white" /></g></svg></div>
                 <div class="buttons-wrapper"><h1>Turn your opinions and discoveries into a payday</h1><button class="main-button" id="show-signup-landing">Sign up</button><button class="secondary-button" id="show-login-landing">Log in</button></div>
            </div>
            <div class="auth-section-inner" id="signup-form-section">
                <div class="form-header"><h1>Welcome!</h1><p>Sign up to get started.</p></div>
                <div class="input-group"><label>Username</label><input type="text" id="signup-username" placeholder="Enter your username"></div>
                <div class="input-group"><label>Email</label><input type="email" id="signup-email" placeholder="Enter your email address"></div>
                <div class="input-group"><label>Password</label><input type="password" id="signup-password" placeholder="Create a password"></div>
                <p class="error-message" id="signup-error-message"></p>
                <button type="submit" class="btn" id="signup-btn">Sign Up</button>
                <div class="switch-form">Already have an account? <a id="show-login">Log in</a></div>
            </div>
            <div class="auth-section-inner" id="login-form-section">
                <div class="form-header"><h1>Good to see you!</h1><p>Let's continue the journey.</p></div>
                <div class="input-group"><label>Email</label><input type="email" id="login-email" placeholder="Enter your email address"></div>
                <div class="input-group"><label>Password</label><input type="password" id="login-password" placeholder="Enter your password"></div>
                <p class="error-message" id="login-error-message"></p>
                <button type="submit" class="btn" id="login-btn">Log In</button>
                <div class="switch-form">Don't have an account? <a id="show-signup">Sign Up</a></div>
            </div>
        </div>

        <!-- MAIN APP SECTION -->
        <div class="section" id="main-app-section">
            <main class="main-content">
                <section id="tasks" class="page active"></section>
                <section id="wallet" class="page"></section>
                <section id="account" class="page"></section>
            </main>
            <nav class="bottom-nav"></nav>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbxp2dGCS4BZ1qlj7dPr4BRvQogIYVCcY",
            authDomain: "survey-io-76104.firebaseapp.com",
            projectId: "survey-io-76104",
            storageBucket: "survey-io-76104.appspot.com",
            messagingSenderId: "788956564253",
            appId: "1:788956564253:web:8eefa99bb1e5be8b67aff4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authSection = document.getElementById('auth-section');
        const mainAppSection = document.getElementById('main-app-section');
        let currentUser = null;
        let userData = {};
        let tasks = [
            { id: 'local1', title: "Daily Lifestyle Survey", price: 2.50, url: "#" },
            { id: 'local2', title: "Tech Gadget Feedback", price: 8.00, url: "#" },
            { id: 'local3', title: "Shopping Habits Poll", price: 3.00, url: "#" },
            { id: 'local4', title: "Media Consumption Survey", price: 5.50, url: "#" },
        ];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                await fetchTasks();
                initializeMainApp();
                authSection.classList.remove('active');
                mainAppSection.classList.add('active');
            } else {
                initializeAuth();
                mainAppSection.classList.remove('active');
                authSection.classList.add('active');
            }
        });

        async function loadUserData() {
            const userRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) userData = docSnap.data();
        }

        async function fetchTasks() {
            const remoteTasks = [];
            const querySnapshot = await getDocs(collection(db, "tasks"));
            querySnapshot.forEach((doc) => remoteTasks.push({ id: doc.id, ...doc.data() }));
            if (remoteTasks.length > 0) tasks = remoteTasks;
        }

        function initializeAuth() {
            const forms = authSection.querySelectorAll('.auth-section-inner');
            const showSection = (id) => { forms.forEach(f => f.classList.remove('active')); document.getElementById(id).classList.add('active'); };
            document.getElementById('show-signup-landing').addEventListener('click', () => showSection('signup-form-section'));
            document.getElementById('show-login-landing').addEventListener('click', () => showSection('login-form-section'));
            document.getElementById('show-login').addEventListener('click', () => showSection('login-form-section'));
            document.getElementById('show-signup').addEventListener('click', () => showSection('signup-form-section'));
            document.getElementById('signup-btn').addEventListener('click', handleSignup);
            document.getElementById('login-btn').addEventListener('click', handleLogin);
        }

        async function handleSignup() {
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const errorEl = document.getElementById('signup-error-message');
            if (!username || !email || !password) { errorEl.textContent = "Please fill all fields."; errorEl.style.display = 'block'; return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: username });
                await setDoc(doc(db, "users", user.uid), {
                    username: username, email: user.email,
                    avatarUrl: "https://i.ibb.co/3k15cSH/man-icon.png", balance: 0.00, dob: "", activities: []
                });
            } catch (error) { errorEl.textContent = error.message; errorEl.style.display = 'block'; }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorEl = document.getElementById('login-error-message');
            if (!email || !password) { errorEl.textContent = "Please fill all fields."; errorEl.style.display = 'block'; return; }
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { errorEl.textContent = "Invalid email or password."; errorEl.style.display = 'block'; }
        }
        
        function initializeMainApp() {
            populateMainAppHTML();
            addMainAppEventListeners();
            renderAllComponents();
        }

        function populateMainAppHTML() {
            mainAppSection.querySelector('#tasks').innerHTML = `
                <header class="page-header">
                    <h2 class="app-title-animated">SURVEYio</h2>
                    <div class="search-container"><input type="search" id="task-search-input" placeholder="Search..."><svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div>
                    <span id="header-balance" class="balance-display">$0.00</span>
                </header>
                <div id="task-list" class="task-list"></div>`;

            mainAppSection.querySelector('#wallet').innerHTML = `
                <div class="wallet-card">
                    <div class="wallet-header"><div class="wallet-chip"></div><div id="wallet-status" class="wallet-status">Pending Goal</div></div>
                    <div class="wallet-balance-label">Current Balance</div><div id="wallet-balance">$0.00</div>
                </div>
                <div class="cash-out-section" style="margin-top: 1.5rem;">
                    <h4>Withdrawal Goal</h4>
                    <div class="progress-bar-container" style="width: 100%; background-color: #e0e0e0; border-radius: 20px;"><div id="withdrawal-progress" style="width: 0%; height: 10px; border-radius: 20px; background: linear-gradient(to right, #4caf50, #81c784);"></div></div>
                    <p class="progress-label" style="font-size: 0.8rem; text-align: center; color: #555; margin-top: 0.5rem;">$<span id="balance-for-progress">0.00</span> / $10.00</p>
                    <button id="cash-out-btn" class="cash-out-btn" disabled>Cash Out</button>
                </div>
                <div class="activities" style="margin-top: 2rem;"><h3>Activities</h3><p id="activities-placeholder">No activities yet.</p><ul id="activities-list"></ul></div>`;
            
            mainAppSection.querySelector('#account').innerHTML = `
                <div class="account-page-content">
                    <div class="profile-display">
                        <img src="https://i.ibb.co/3k15cSH/man-icon.png" alt="Profile Avatar" id="profile-avatar" class="profile-avatar">
                        <h2 id="profile-name">User</h2><p id="profile-email" class="profile-email"></p>
                    </div>
                    <div class="accordion-card">
                        <div class="accordion-header"><h4>Edit Profile</h4><span class="arrow-icon">▼</span></div>
                        <div class="accordion-content">
                            <div class="form-group"><label for="full-name">Full Name</label><input type="text" id="full-name"></div>
                            <div class="form-group"><label for="dob">Date of Birth</label><input type="date" id="dob"></div>
                            <label>Choose Your Avatar</label>
                            <div class="avatar-selection">
                                <img src="https://i.ibb.co/3k15cSH/man-icon.png" class="avatar-option" alt="Man Icon"><img src="https://i.ibb.co/bFqg0Y8/woman-icon.png" class="avatar-option" alt="Woman Icon">
                                <img src="https://i.ibb.co/L52Xk5H/boy-icon.png" class="avatar-option" alt="Boy Icon"><img src="https://i.ibb.co/QvYgq31/student-icon.png" class="avatar-option" alt="Student Icon">
                            </div>
                            <button id="save-profile-btn" class="save-btn" style="margin-top: 1.5rem;">Save Changes</button>
                        </div>
                    </div>
                    <div class="accordion-card">
                        <div class="accordion-header"><h4>Support & Contact</h4><span class="arrow-icon">▼</span></div>
                        <div class="accordion-content">
                            <p>For any issues or inquiries, please contact our support team or the developer directly.</p>
                            <a href="mailto:support@surveyio.com"><strong>Support:</strong> support@surveyio.com</a><hr style="border:0; border-top: 1px solid var(--border-color); margin: 1rem 0;">
                            <a href="mailto:hasibulmahir@gmail.com"><strong>Developer:</strong> hasibulmahir@gmail.com</a>
                        </div>
                    </div>
                    <div class="accordion-card">
                        <div class="accordion-header"><h4>Watch Tutorial</h4><span class="arrow-icon">▼</span></div>
                        <div class="accordion-content">
                            <p>Learn how to get started and maximize your earnings with our quick tutorial video.</p>
                            <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank" class="action-button logout-btn">Watch Video</a>
                        </div>
                    </div>
                    <div class="accordion-card">
                        <div class="accordion-header"><h4>Join Official Channel</h4><span class="arrow-icon">▼</span></div>
                        <div class="accordion-content">
                             <p>Stay updated with new tasks and announcements by joining our community channels.</p>
                            <a href="#" target="_blank" class="social-button telegram">Join on Telegram</a>
                            <a href="#" target="_blank" class="social-button whatsapp">Join on WhatsApp</a>
                        </div>
                    </div>
                     <div class="accordion-card">
                        <div class="accordion-header"><h4>Community & Guidelines</h4><span class="arrow-icon">▼</span></div>
                        <div class="accordion-content">
                            <p>1. Be respectful to all members.<br>2. Do not share personal information.<br>3. Complete tasks honestly.</p>
                        </div>
                    </div>
                    <div style="margin-top: 2rem;"><button class="action-button logout-btn">Logout</button></div>
                </div>`;

            mainAppSection.querySelector('.bottom-nav').innerHTML = `
                <a href="#tasks" class="nav-item active" data-page="tasks"><div class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div><div>Tasks</div></a>
                <a href="#wallet" class="nav-item" data-page="wallet"><div class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></div><div>Wallet</div></a>
                <a href="#account" class="nav-item" data-page="account"><div class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div>Account</div></a>`;
        }
        
        function addMainAppEventListeners() {
            document.getElementById('task-search-input').addEventListener('input', (e) => renderTasks(e.target.value));
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = e.currentTarget.dataset.page;
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                mainAppSection.querySelector(`#${pageId}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                e.currentTarget.classList.add('active');
            }));
            document.querySelectorAll('.accordion-header').forEach(header => header.addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('active');
                e.currentTarget.nextElementSibling.classList.toggle('show');
            }));
            document.querySelectorAll('.avatar-option').forEach(option => option.addEventListener('click', (e) => {
                document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
            }));
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
            document.querySelector('.logout-btn').addEventListener('click', async () => { await signOut(auth); });
        }

        function renderAllComponents() {
            renderProfile();
            updateBalanceUI();
            renderTasks();
        }

        function renderProfile() {
            document.getElementById('profile-name').textContent = userData.username || 'User';
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-avatar').src = userData.avatarUrl || 'https://i.ibb.co/3k15cSH/man-icon.png';
            document.getElementById('full-name').value = userData.username || '';
            document.getElementById('dob').value = userData.dob || '';
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            const currentAvatar = document.querySelector(`.avatar-option[src="${userData.avatarUrl}"]`);
            if(currentAvatar) currentAvatar.classList.add('selected');
            else document.querySelector('.avatar-option').classList.add('selected');
        }

        function updateBalanceUI() {
            const balance = userData.balance || 0;
            document.getElementById('header-balance').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('wallet-balance').textContent = `$${balance.toFixed(2)}`;
            const progress = (Math.min(balance / 10, 1) * 100);
            document.getElementById('withdrawal-progress').style.width = `${progress}%`;
            document.getElementById('balance-for-progress').textContent = balance.toFixed(2);
            document.getElementById('cash-out-btn').disabled = balance < 10;
        }

        function renderTasks(filter = '') {
            const taskList = document.getElementById("task-list");
            const searchTerm = filter.toLowerCase();
            const filteredTasks = tasks.filter(task => task.title.toLowerCase().includes(searchTerm));
            taskList.innerHTML = "";
            if (filteredTasks.length === 0) { taskList.innerHTML = `<div>No tasks found.</div>`; return; }
            filteredTasks.forEach(task => {
                const card = document.createElement("div");
                card.className = 'task-card';
                card.innerHTML = `<div class="task-card-header"><h3>$${task.price.toFixed(2)}</h3></div><h4 class="task-title">${task.title}</h4>`;
                card.addEventListener('click', () => handleTaskCompletion(task));
                taskList.appendChild(card);
            });
        }
        
        async function saveProfile() {
            const newName = document.getElementById('full-name').value;
            const newDob = document.getElementById('dob').value;
            const newAvatar = document.querySelector('.avatar-option.selected').src;
            const userRef = doc(db, "users", currentUser.uid);
            try {
                await updateDoc(userRef, { username: newName, dob: newDob, avatarUrl: newAvatar });
                await loadUserData();
                renderProfile();
                const btn = document.getElementById('save-profile-btn');
                btn.textContent = 'Saved!'; btn.classList.add('saved');
                setTimeout(() => { btn.textContent = 'Save Changes'; btn.classList.remove('saved'); }, 2000);
            } catch (error) { console.error("Error saving profile:", error); }
        }

        async function handleTaskCompletion(task) {
            const newBalance = (userData.balance || 0) + task.price;
            const userRef = doc(db, "users", currentUser.uid);
            const newActivity = { title: task.title, amount: task.price, date: new Date().toISOString() };
            try {
                await updateDoc(userRef, { balance: newBalance, activities: arrayUnion(newActivity) });
                alert(`You earned $${task.price.toFixed(2)}!`);
                await loadUserData();
                updateBalanceUI();
            } catch (error) { console.error("Error completing task:", error); }
        }
    </script>
</body>
</html>
